
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Word Kingdom - å•è¯ç‹å›½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap');
        body { font-family: 'Quicksand', sans-serif; background-color: #1e1b4b; margin: 0; overflow: hidden; user-select: none; color: white; }
        #loading-overlay { position: fixed; inset: 0; background: #1e1b4b; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s; }
        .loader-castle { font-size: 80px; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .progress-container { width: 280px; height: 12px; background: #312e81; border: 2px solid #4f46e5; border-radius: 20px; margin-top: 20px; overflow: hidden; position: relative; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #4f46e5, #818cf8); transition: width 0.3s; }
        .pixel-border { border: 4px solid black; box-shadow: 6px 6px 0px rgba(0,0,0,0.3); }
        .pixel-button { background: #4f46e5; color: white; border: 4px solid black; padding: 12px 24px; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: all 0.1s; box-shadow: 4px 4px 0px black; position: relative; }
        .pixel-button:hover { background: #6366f1; transform: translate(-2px, -2px); box-shadow: 6px 6px 0px black; }
        .pixel-button:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px black; }
        .pixel-button:disabled { background: #475569; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.5; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .floating { animation: float 3s ease-in-out infinite; }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="loading-overlay">
        <div class="loader-castle">ğŸ°</div>
        <div class="text-xl font-bold mt-4 uppercase tracking-tighter">é­”æ³•é˜µå¼€å¯ä¸­...</div>
        <div class="progress-container"><div id="progress-bar"></div></div>
        <div id="loading-status" class="mt-2 text-xs text-indigo-400 font-mono">æ­£åœ¨æ ¡å‡†è¯æ³•èƒ½é‡...</div>
        <div id="error-console" style="display:none;" class="mt-4 p-4 bg-red-900 border-2 border-red-500 rounded text-[10px] text-red-200">
            <pre id="error-text"></pre>
        </div>
    </div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        /** ================= CONSTANTS & DATA ================= **/
        const WORLDS = [
            { id: 1, name: "Ancient Valley (Unit 1)", theme: "emerald", color: "#10b981" },
            { id: 2, name: "Cozy Home (Unit 2)", theme: "amber", color: "#f59e0b" },
            { id: 3, name: "Social Plaza (Unit 3)", theme: "blue", color: "#3b82f6" },
            { id: 4, name: "Adventure Peak (Unit 4)", theme: "purple", color: "#8b5cf6" },
            { id: 5, name: "Health Canyon (Unit 5)", theme: "indigo", color: "#6366f1" },
            { id: 6, name: "Future City (Unit 6)", theme: "cyan", color: "#06b6d4" },
            { id: 7, name: "Gourmet Island (Unit 7)", theme: "rose", color: "#f43f5e" },
            { id: 8, name: "Wisdom Temple (Unit 8)", theme: "orange", color: "#f97316" }
        ];

        // ç®€åŒ–çš„å…¨é‡å•è¯æ•°æ®åº“ï¼ˆç¤ºä¾‹ï¼‰
        const RAW_WORDS = {
            1: [
                { id: 'u1-1', english: 'ancient', chinese: 'å¤ä»£çš„', pos: 'adj', example: 'This is an ancient building.' },
                { id: 'u1-2', english: 'camp', chinese: 'è¥åœ°', pos: 'n', example: 'We stay at the camp.' },
                { id: 'u1-3', english: 'landscape', chinese: 'é£æ™¯', pos: 'n', example: 'The landscape is beautiful.' },
                { id: 'u1-4', english: 'strange', chinese: 'å¥‡æ€ªçš„', pos: 'adj', example: 'That is a strange bird.' },
                { id: 'u1-5', english: 'vacation', chinese: 'å‡æœŸ', pos: 'n', example: 'I like my summer vacation.' },
                { id: 'u1-6', english: 'fantastic', chinese: 'æå¥½çš„', pos: 'adj', example: 'We had a fantastic time.' },
                { id: 'u1-7', english: 'town', chinese: 'åŸé•‡', pos: 'n', example: 'My town is very small.' },
                { id: 'u1-8', english: 'comfortable', chinese: 'èˆ’é€‚çš„', pos: 'adj', example: 'This sofa is comfortable.' }
            ],
            2: [
                { id: 'u2-1', english: 'kitchen', chinese: 'å¨æˆ¿', pos: 'n', example: 'Mom is in the kitchen.' },
                { id: 'u2-2', english: 'furniture', chinese: 'å®¶å…·', pos: 'n', example: 'We bought new furniture.' },
                { id: 'u2-3', english: 'fridge', chinese: 'å†°ç®±', pos: 'n', example: 'Milk is in the fridge.' },
                { id: 'u2-4', english: 'bathroom', chinese: 'æµ´å®¤', pos: 'n', example: 'The bathroom is clean.' }
            ],
            // æ›´å¤š Unit å¯ä»¥ç»§ç»­è¡¥å……...
        };

        const HEROES = [
            { id: 'h1', name: 'Princess Sky', color: '#10b981', power: 'Wind', desc: 'çµåŠ¨å¦‚é£ï¼Œæ¢ç´¢è¯æ³•ã€‚' },
            { id: 'h2', name: 'Valiant Prince', color: '#ef4444', power: 'Fire', desc: 'å‹‡æ•¢å®ˆæŠ¤ï¼Œå‡»ç¢éšœç¢ã€‚' },
            { id: 'h3', name: 'Red Hood', color: '#6366f1', power: 'Night', desc: 'ç©¿æ¢­æ—é—´ï¼Œå¯»æ‰¾çœŸç†ã€‚' },
            { id: 'h4', name: 'Earth Ivy', color: '#3b82f6', power: 'Earth', desc: 'åšç§¯è–„å‘ï¼Œæ·±æ‰æ ¹åŸºã€‚' }
        ];

        /** ================= COMPONENTS ================= **/

        const PixelSprite = ({ type, color, action = 'idle' }) => {
            const isHit = action === 'hit';
            const isAttack = action === 'attack';
            return (
                <div className={`relative w-24 h-24 flex items-end justify-center transition-all duration-300 ${isAttack ? (type === 'hero' ? 'translate-x-12' : '-translate-x-12') : ''} ${isHit ? 'animate-bounce' : 'animate-pulse'}`}>
                    <svg width="100%" height="100%" viewBox="0 0 100 100">
                        {/* ç®€æ˜“åƒç´ è§’è‰² */}
                        <rect x="25" y="40" width="50" height="50" fill={color} stroke="black" strokeWidth="4" />
                        <rect x="35" y="55" width="8" height="8" fill="black" />
                        <rect x="57" y="55" width="8" height="8" fill="black" />
                        <rect x="40" y="75" width="20" height="4" fill="black" opacity="0.3" />
                        {type === 'monster' && <path d="M30,30 L40,45 M70,30 L60,45" stroke="black" strokeWidth="4" />}
                    </svg>
                    {isHit && <div className="absolute top-0 text-red-500 font-black text-xl">-10</div>}
                </div>
            );
        };

        const BattleView = ({ hero, monsterColor, heroAction, monsterAction }) => (
            <div className="w-full h-48 pixel-border bg-sky-200 rounded-[30px] flex items-end justify-between px-12 pb-6 relative overflow-hidden">
                <div className="absolute inset-0 bg-gradient-to-b from-sky-400 to-green-300 opacity-50"></div>
                <PixelSprite type="hero" color={hero.color} action={heroAction} />
                <PixelSprite type="monster" color={monsterColor} action={monsterAction} />
            </div>
        );

        /** Stage 1: Recognition (çœ‹è‹±æ–‡é€‰ä¸­æ–‡) **/
        const StageOne = ({ words, hero, onComplete, onFail }) => {
            const [idx, setIdx] = useState(0);
            const [feedback, setFeedback] = useState(null);
            const word = words[idx];
            
            const options = useMemo(() => {
                const others = RAW_WORDS[1].filter(w => w.id !== word.id).map(w => w.chinese);
                return [word.chinese, ...others.sort(() => Math.random() - 0.5).slice(0, 3)].sort(() => Math.random() - 0.5);
            }, [idx]);

            const handleAnswer = (ans) => {
                if (ans === word.chinese) {
                    setFeedback('correct');
                    setTimeout(() => {
                        setFeedback(null);
                        if (idx + 1 < words.length) setIdx(idx + 1);
                        else onComplete();
                    }, 600);
                } else {
                    setFeedback('wrong');
                    setTimeout(() => setFeedback(null), 600);
                }
            };

            return (
                <div className="h-full flex flex-col gap-6">
                    <BattleView hero={hero} monsterColor="#475569" heroAction={feedback==='correct'?'attack':'idle'} monsterAction={feedback==='wrong'?'attack':(feedback==='correct'?'hit':'idle')} />
                    <div className="flex-1 flex flex-col items-center justify-center gap-8">
                        <div className="text-6xl font-black uppercase text-indigo-900 tracking-widest">{word.english}</div>
                        <div className="grid grid-cols-2 gap-4 w-full max-w-xl">
                            {options.map((opt, i) => (
                                <button key={i} onClick={() => handleAnswer(opt)} className="pixel-button text-xl h-20">
                                    {opt}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        /** Stage 2: Consolidation (å•è¯æ‹¼å†™å¡«ç©º) **/
        const StageTwo = ({ words, hero, onComplete }) => {
            const [idx, setIdx] = useState(0);
            const word = words[idx];
            const [userInput, setUserInput] = useState('');
            const [feedback, setFeedback] = useState(null);

            // æŒ–æ‰ä¸­é—´çš„å­—æ¯
            const displayWord = useMemo(() => {
                const arr = word.english.split('');
                const mid = Math.floor(arr.length / 2);
                arr[mid] = '_';
                return { text: arr.join(''), missing: word.english[mid] };
            }, [idx]);

            const handleKey = (char) => {
                if (char === displayWord.missing) {
                    setFeedback('correct');
                    setTimeout(() => {
                        setFeedback(null);
                        if (idx + 1 < words.length) setIdx(idx + 1);
                        else onComplete();
                    }, 600);
                } else {
                    setFeedback('wrong');
                    setTimeout(() => setFeedback(null), 600);
                }
            };

            return (
                <div className="h-full flex flex-col gap-6">
                    <BattleView hero={hero} monsterColor="#059669" heroAction={feedback==='correct'?'attack':'idle'} monsterAction={feedback==='wrong'?'attack':(feedback==='correct'?'hit':'idle')} />
                    <div className="flex-1 flex flex-col items-center justify-center gap-8">
                        <div className="text-4xl font-black text-indigo-900 mb-2">{word.chinese}</div>
                        <div className="text-7xl font-black text-indigo-900 tracking-[0.2em]">{displayWord.text.toUpperCase()}</div>
                        <div className="flex gap-2 flex-wrap justify-center max-w-lg">
                            {"abcdefghijklmnopqrstuvwxyz".split('').map(l => (
                                <button key={l} onClick={() => handleKey(l)} className="w-10 h-10 pixel-border bg-white text-black font-bold hover:bg-indigo-100 uppercase">
                                    {l}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        /** Stage 3: Application (è¿è¯æˆå¥) **/
        const StageThree = ({ words, hero, onComplete }) => {
            const [idx, setIdx] = useState(0);
            const word = words[idx];
            const correctSeq = word.example.replace(/[.!?]/g, '').split(' ');
            const [selected, setSelected] = useState([]);
            const [pool, setPool] = useState([...correctSeq].sort(() => Math.random() - 0.5));
            const [feedback, setFeedback] = useState(null);

            const toggle = (w, isPool) => {
                if(isPool) {
                    setSelected([...selected, w]);
                    const newPool = [...pool]; newPool.splice(newPool.indexOf(w), 1);
                    setPool(newPool);
                } else {
                    setPool([...pool, w]);
                    const newSelected = [...selected]; newSelected.splice(newSelected.indexOf(w), 1);
                    setSelected(newSelected);
                }
            };

            const check = () => {
                if(selected.join(' ') === correctSeq.join(' ')) {
                    setFeedback('correct');
                    setTimeout(() => {
                        setFeedback(null);
                        if(idx + 1 < words.length) {
                            setIdx(idx + 1); setSelected([]);
                            const next = words[idx+1].example.replace(/[.!?]/g, '').split(' ');
                            setPool([...next].sort(() => Math.random() - 0.5));
                        } else onComplete();
                    }, 800);
                } else {
                    setFeedback('wrong');
                    setTimeout(() => setFeedback(null), 800);
                }
            };

            return (
                <div className="h-full flex flex-col gap-6">
                    <BattleView hero={hero} monsterColor="#b91c1c" heroAction={feedback==='correct'?'attack':'idle'} monsterAction={feedback==='wrong'?'attack':(feedback==='correct'?'hit':'idle')} />
                    <div className="flex-1 flex flex-col items-center justify-center gap-6 p-4">
                        <div className="text-2xl font-black text-indigo-900 bg-white/50 px-6 py-2 rounded-full mb-4">ç›®æ ‡è¯æ±‡: {word.english} ({word.chinese})</div>
                        <div className="w-full min-h-[80px] pixel-border bg-white/30 p-4 flex flex-wrap gap-2">
                            {selected.map((w, i) => <button key={i} onClick={()=>toggle(w, false)} className="pixel-button bg-indigo-600 text-sm py-2 px-4">{w}</button>)}
                        </div>
                        <div className="flex flex-wrap gap-2 justify-center">
                            {pool.map((w, i) => <button key={i} onClick={()=>toggle(w, true)} className="pixel-button bg-white text-indigo-900 text-sm py-2 px-4">{w}</button>)}
                        </div>
                        <button onClick={check} disabled={selected.length === 0} className="pixel-button bg-yellow-400 text-indigo-900 mt-4 px-12 py-4 text-xl">ç¡®è®¤é­”æ³•é˜µ</button>
                    </div>
                </div>
            );
        };

        /** ================= MAIN APP ================= **/
        const App = () => {
            const [gameState, setGameState] = useState('LOGIN');
            const [user, setUser] = useState(null);
            const [hero, setHero] = useState(null);
            const [currentWorld, setCurrentWorld] = useState(null);
            const [currentStage, setCurrentStage] = useState(1); // 1:è®¤è¯», 2:å·©å›º, 3:åº”ç”¨

            // åŠ è½½å­˜æ¡£
            useEffect(() => {
                const saved = localStorage.getItem('PIXEL_WORD_SAVE');
                if(saved) setUser(JSON.parse(saved));
            }, []);

            const handleLogin = (id) => {
                const newUser = user || { id, unlocked: ['w1'], stars: {} };
                setUser(newUser);
                localStorage.setItem('PIXEL_WORD_SAVE', JSON.stringify(newUser));
                setGameState('HERO');
            };

            const startLevel = (world) => {
                setCurrentWorld(world);
                setCurrentStage(1);
                setGameState('GAME');
            };

            if (gameState === 'LOGIN') return (
                <div className="h-screen flex flex-col items-center justify-center p-8 bg-indigo-900">
                    <div className="bg-white p-12 pixel-border flex flex-col gap-8 text-indigo-900 max-w-sm w-full">
                        <h1 className="text-4xl font-black text-center uppercase tracking-tighter">Word Kingdom</h1>
                        <input id="userId" className="border-4 border-black p-4 text-xl outline-none font-bold" placeholder="è¾“å…¥å‹‡è€… ID" defaultValue="Player1" />
                        <button onClick={() => handleLogin(document.getElementById('userId').value)} className="pixel-button bg-yellow-400 text-indigo-900 py-4 text-2xl">å¼€å¯å†’é™©</button>
                    </div>
                </div>
            );

            if (gameState === 'HERO') return (
                <div className="h-screen flex flex-col items-center justify-center p-8 bg-indigo-950">
                    <h2 className="text-3xl font-black mb-12 uppercase">å¬å”¤ä½ çš„å®ˆæŠ¤è€…</h2>
                    <div className="flex gap-6 overflow-x-auto pb-8 w-full max-w-5xl px-4">
                        {HEROES.map(h => (
                            <div key={h.id} onClick={() => { setHero(h); setGameState('MAP'); }} className="min-w-[240px] bg-white p-8 pixel-border text-indigo-900 cursor-pointer hover:bg-yellow-50 hover:-translate-y-2 transition-all flex flex-col items-center">
                                <PixelSprite color={h.color} />
                                <div className="mt-6 font-black text-2xl uppercase">{h.name}</div>
                                <div className="mt-2 text-xs font-bold text-indigo-400">{h.power} Power</div>
                                <div className="mt-4 text-sm text-center font-medium leading-relaxed">{h.desc}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            if (gameState === 'MAP') return (
                <div className="h-screen overflow-y-auto p-8 bg-sky-100 text-indigo-900 scrollbar-hide">
                    <div className="max-w-4xl mx-auto">
                        <header className="flex justify-between items-center mb-12">
                            <h1 className="text-4xl font-black uppercase tracking-widest">Adventure Map</h1>
                            <div className="bg-white px-6 py-2 pixel-border font-black">å‹‡è€…: {user.id}</div>
                        </header>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            {WORLDS.map(w => (
                                <div key={w.id} className="bg-white p-8 pixel-border group relative overflow-hidden">
                                    <div className={`absolute top-0 right-0 w-24 h-24 opacity-10 rotate-12 -mr-6 -mt-6 rounded-full`} style={{backgroundColor: w.color}}></div>
                                    <div className="text-2xl font-black mb-6 flex items-center gap-3">
                                        <div className="w-4 h-4 rounded-full" style={{backgroundColor: w.color}}></div>
                                        {w.name}
                                    </div>
                                    <div className="flex gap-4">
                                        {[1, 2, 3, 4].map(s => (
                                            <button key={s} onClick={() => startLevel(w)} className="w-14 h-14 bg-white border-2 border-black font-black text-xl hover:bg-indigo-600 hover:text-white transition-colors flex items-center justify-center shadow-[4px_4px_0_black] active:shadow-none active:translate-x-1 active:translate-y-1">
                                                {s}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            if (gameState === 'GAME') {
                const levelWords = RAW_WORDS[currentWorld.id] || RAW_WORDS[1];
                return (
                    <div className="h-screen bg-sky-50 p-6 flex flex-col">
                        <div className="h-16 flex justify-between items-center px-4 mb-4">
                            <button onClick={() => setGameState('MAP')} className="font-black text-red-500 pixel-border bg-white px-4 py-1">é€€å‡º</button>
                            <div className="flex flex-col items-center">
                                <div className="text-xs font-black uppercase text-indigo-400">æ­£åœ¨æŒ‘æˆ˜</div>
                                <div className="text-xl font-black text-indigo-900">{currentWorld.name}</div>
                            </div>
                            <div className="font-black bg-indigo-600 text-white px-4 py-1 rounded-full uppercase text-xs">é˜¶æ®µ {currentStage}/3</div>
                        </div>
                        <div className="flex-1 overflow-hidden">
                            {currentStage === 1 && <StageOne words={levelWords} hero={hero} onComplete={() => setCurrentStage(2)} />}
                            {currentStage === 2 && <StageTwo words={levelWords} hero={hero} onComplete={() => setCurrentStage(3)} />}
                            {currentStage === 3 && <StageThree words={levelWords} hero={hero} onComplete={() => setGameState('WIN')} />}
                        </div>
                    </div>
                );
            }

            if (gameState === 'WIN') return (
                <div className="h-screen flex flex-col items-center justify-center p-8 bg-emerald-600">
                    <div className="text-9xl mb-8 floating">ğŸ†</div>
                    <h2 className="text-6xl font-black mb-4 uppercase">å†’é™©å¤§èƒœåˆ©!</h2>
                    <p className="text-2xl font-bold opacity-80 mb-12">ä½ æˆåŠŸæ”¶å¤äº†è¯æ±‡é¢†åœ°ã€‚</p>
                    <div className="flex gap-4">
                        <button onClick={() => setGameState('MAP')} className="pixel-button bg-yellow-400 text-indigo-900 px-12 py-6 text-2xl">å›åˆ°åœ°å›¾</button>
                    </div>
                </div>
            );

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        window.dispatchEvent(new Event('game-ready'));
    </script>

    <script>
        // åŠ è½½åŠ¨ç”»æ§åˆ¶
        const progressBar = document.getElementById('progress-bar');
        const loadingOverlay = document.getElementById('loading-overlay');
        let progress = 0;
        const interval = setInterval(() => {
            if (progress < 98) {
                progress += Math.random() * 8;
                progressBar.style.width = Math.min(progress, 98) + '%';
            }
        }, 150);

        window.addEventListener('game-ready', () => {
            clearInterval(interval);
            progressBar.style.width = '100%';
            setTimeout(() => {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => loadingOverlay.remove(), 500);
            }, 600);
        });

        window.onerror = (msg, src, line) => {
            document.getElementById('error-console').style.display = 'block';
            document.getElementById('error-text').innerText += `\n[Fatal] ${msg} (Line ${line})`;
        };
    </script>
</body>
</html>
